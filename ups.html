<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Smart UPS Battery Monitoring System </title>

	<script type="text/javascript" src="js\jquery.min.js"></script> 
	<style>
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
		}
		th, td {
			padding: 5px;
			text-align: left;    
		}
	</style>	
	<script>
		var sensorKey=[];
		var sensorCh=[];
		var sensorAdd=[];
		var sensorLoc=[];
		var entryArray=[];
		var axn = 0;
		var filNo = 0;
		var sensorDat = [];
		var sensorDatT = [];
		var sensorDatV = [];
		var sensorDatIR = [];
		var sensorDatSOH = [];
		var temporaryDat = [];
		var IsOffline = 0;
		var IsTempNormal = 0;
		var IsVoltNormal = 0;
		var IsIRNormal = 0;
		var IsSOHNormal = 0;
		
		$(document).ready(function() {
			setInterval(function() { 
				get_data();
			},15000);
		});
		// converts date format from JSON  
		function getDate(d) {  
		    // get the data using javascript's date object (year, month, day, hour, minute, second)  
		    // months in javascript start at 0, so remember to subtract 1 when specifying the month  
		    // offset in minutes is converted to milliseconds and subtracted so that chart's x-axis is correct  
		    return Date.UTC(d.substring(0,4), d.substring(5,7)-1, d.substring(8,10), d.substring(11,13), d.substring(14,16), d.substring(17,19));// - (myOffset * 60000);  
		}  
		
		function showForm(){
			    var popup = document.getElementById("myPopup");
			    popup.classList.toggle("show");
		}

		function hideForm(){
			    var popup = document.getElementById("myPopup");
			    popup.classList.toggle("show");
		}
		function gotoURL(x) {
			localStorage.removeItem("channel");
			localStorage.removeItem("apikey");
			localStorage.setItem("channel", sensorAdd[x]);
			localStorage.setItem("apikey", sensorKey[x]);
		    	location.href = 'dashboard-graph.html';
		}
		
		function get_device(){
			$.get('https://api.thingspeak.com/channels/311561/feeds.json?api_key=BO36593Y0EK1YBNU&results=5000',function(data){
				//console.log(data);
				var x=0;
				for (var i = 0; i<=data.feeds.length-1; i++){
					if(data.feeds[i].field3 =="UPS") {
						sensorKey[i] = (data.feeds[i].field2);
						sensorLoc[i] = (data.feeds[i].field4);
						sensorAdd[i] = (data.feeds[i].field1);
						sensorCh[i] = (data.feeds[i].field5);
						entryArray[i] = (data.feeds[i].created_at);
					}
					
				}
			});
			get_data();
		}
		
		function get_data(){
			var x = 0; 
			$.get('https://api.thingspeak.com/channels/311561/feeds.json?api_key=BO36593Y0EK1YBNU&results=5000',function(moddata){
				axn=moddata.feeds.length;
			});
			for(h=0; h<=(axn-1);h++){					
				$.getJSON('https://api.thingspeak.com/channels/'+sensorCh[h]+'/feeds.json?api_key='+sensorKey[h]+'&results=1',function(data){
					if(data.feeds.length!=0)
					{
						for(x=0;x<(axn-1);x++){
							if(data.channel.name == sensorAdd[x])
							{
								console.log('https://api.thingspeak.com/channels/'+sensorCh[x]+'/feeds.json?api_key='+sensorKey[x]+'&results=1');
						
								console.log(data);
							
								var current_date = new Date();
								var rhrs = current_date.getHours();
								current_date.setHours(rhrs+8);
								console.log(getDate(current_date.toISOString()));
								console.log(getDate(data.feeds[0].created_at));
									
								if((getDate(current_date.toISOString())-(getDate(data.feeds[0].created_at))) > 1000000000)
								{
									IsOffline = 1;
								}
								else
								{
									IsOffline = 0;
								}
								
								sensorDatT [x] = parseFloat(data.feeds[0].field1).toFixed(2);	
								sensorDatV [x] = parseFloat(data.feeds[0].field2).toFixed(2);			
								sensorDatIR [x] = parseFloat(data.feeds[0].field3).toFixed(2);			
								sensorDatSOH [x] = parseFloat(data.feeds[0].field4).toFixed(2);			
								
								if((sensorDatT [x]<35.0)&&(sensorDatT [x]>29.99)){
								   	IsTempNormal = 1;
								}
								else if((sensorDatT [x]<30.0)&&(sensorDatT [x]>18.0)){
								   	IsTempNormal = 0;
								}
								else {
									IsTempNormal = 2;
								}
								   
								if((sensorDatV [x]<16.0)&&(sensorDatV [x]>13.5)){
								   	IsVoltNormal = 0;
								}
								else if((sensorDatV [x]<13.51)&&(sensorDatV [x]>13.0)){
								   	IsVoltNormal = 1;
								}
								else {
									IsVoltNormal = 2;
								}
								
								if((sensorDatIR [x] > 6.0)||(sensorDatIR [x] == "Nan")||(sensorDatIR [x] == 0.0)){
								   	IsIRNormal = 2;
								}
								else if((sensorDatIR [x] < 6.1)&&(sensorDatIR [x] > 4.0)){
								   	IsIRNormal = 1;
								}
								else {
									IsIRNormal =0;
								}
								
								if((sensorDatSOH [x] < 50.0)||(sensorDatSOH [x] == "Nan")||(sensorDatSOH [x] == 0.0)){
								   	IsSOHNormal = 2;
								}
								else if((sensorDatIR [x] < 80.0)&&(sensorDatIR [x] > 50.1)){
								   	IsSOHNormal = 1;
								}
								else {
									IsSOHNormal =0;
								}
								if (IsOffline==0){
									if((IsTempNormal== 0)&&(IsVoltNormal == 0)&&(IsIRNormal == 0)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_green.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 0)&&(IsIRNormal == 0)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 1)&&(IsIRNormal == 0)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 0)&&(IsIRNormal == 1)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 0)&&(IsIRNormal == 0)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 1)&&(IsIRNormal == 0)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 1)&&(IsIRNormal == 1)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 0)&&(IsIRNormal == 1)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 0)&&(IsIRNormal == 0)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 1)&&(IsIRNormal == 1)&&(IsSOHNormal == 0)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 0)&&(IsVoltNormal == 1)&&(IsIRNormal == 1)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 0)&&(IsIRNormal == 1)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 1)&&(IsIRNormal == 0)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else if((IsTempNormal== 1)&&(IsVoltNormal == 1)&&(IsIRNormal == 1)&&(IsSOHNormal == 1)){
										document.getElementById(sensorLoc[x]).src = "images/bat_yellow.png";
									}
									else{
										document.getElementById(sensorLoc[x]).src = "images/bat_red.png";
									}
								}
								else{
									document.getElementById(sensorLoc[x]).src = "images/bat_red.png";
								}
								
								break;
							}
						}
						if (x>=(axn-1)){
							console.log(data.channel.name)
						}
					}
				});
			}
		}

	</script>	

    <!-- Bootstrap Core CSS -->
    <link href="/smartups/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/smartups/vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="/smartups/vendor/datatables-plugins/dataTables.bootstrap.css" rel="stylesheet">

    <!-- DataTables Responsive CSS -->
    <link href="/smartups/vendor/datatables-responsive/dataTables.responsive.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/smartups/dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/smartups/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body onload="get_device()">
    <div id="wrapper">
        <div>
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header"> 
			    <img src="images/logo.png" hspace="20" style="width:100px;"> 
			    Smart UPS Battery Monitoring System (Beta)</h1>
			<a class="btn" href="">Login</a>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Available Data
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body" id="data_for">
				<br>
				<br>
				<table class="table table-striped table-bordered table-hover" id="dataTables-example">
	
					<tr>
						<td>
						<a onclick="gotoURL(0)">
						<img id="B1PH2-B3D3-C01" src="images\bat_gray.png" style="float: left; width: 5%; margin-left: 2.5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C02" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C03" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C04" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C05" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C06" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C07" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C08" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C09" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C10" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C11" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C12" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C13" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C14" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C15" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C16" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 2.5%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C17" src="images\bat_gray.png" style="float: left; width: 5%;  margin-left: 2.5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C18" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C19" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C20" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C21" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C22" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C23" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C24" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C25" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C26" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C27" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C28" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C29" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C30" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C31" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;" >
						</a>
						<a href="dashboard-graph.html">
						<img id="B1PH2-B3D3-C32" src="images\bat_gray.png" style="float: left; width: 5%; margin-right: 2.5%; margin-bottom: 0.5em;" >
						</a>
						</td>

					</tr>
				</table>
	
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->

        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="/smartups/vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/smartups/vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="/smartups/vendor/metisMenu/metisMenu.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/smartups/vendor/datatables/js/jquery.dataTables.min.js"></script>
    <script src="/smartups/vendor/datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script src="/smartups/vendor/datatables-responsive/dataTables.responsive.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/smartups/dist/js/sb-admin-2.js"></script>

    <!-- Page-Level Demo Scripts - Tables - Use for reference -->

</body>
</html>
